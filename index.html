<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Valoraciones con Fotos</title>
</head>
<body>

<h2>Deja tu valoración</h2>
<form id="reviewForm">
  <label>Nombre:</label><br>
  <input type="text" id="name" required><br><br>

  <label>Comentario:</label><br>
  <textarea id="comment" rows="3" required></textarea><br><br>

  <label>Estrellas:</label><br>
  <select id="rating" required>
    <option value="1">⭐</option>
    <option value="2">⭐⭐</option>
    <option value="3">⭐⭐⭐</option>
    <option value="4">⭐⭐⭐⭐</option>
    <option value="5">⭐⭐⭐⭐⭐</option>
  </select><br><br>

  <label>Foto (opcional, max 2MB):</label><br>
  <input type="file" id="photo" accept="image/*"><br><br>

  <button type="submit">Enviar valoración</button>
</form>

<h2>Valoraciones aprobadas</h2>
<div id="reviews"></div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

    <script>

        // Configuración real de Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBqGTWa97hI7Olw1LqRKlXtKi6Y5yV0Yks",
            authDomain: "valoracion-web-11af4.firebaseapp.com",
            projectId: "valoracion-web-11af4",
            storageBucket: "valoracion-web-11af4.appspot.com",
            messagingSenderId: "281280264244",
            appId: "1:281280264244:web:6a07b7c0b61872ecf73261"
        };

// Inicializa Firebase
firebase.initializeApp(firebaseConfig);

const db = firebase.database();
const storage = firebase.storage();

// Enviar valoración
document.getElementById('reviewForm').addEventListener('submit', async (e) => {
  e.preventDefault();

  const name = document.getElementById('name').value.trim();
  const comment = document.getElementById('comment').value.trim();
  const rating = document.getElementById('rating').value;
  const file = document.getElementById('photo').files[0];

  let photoURL = "";

  if (file) {
    if (file.size > 2 * 1024 * 1024) {
      alert("La foto supera los 2 MB.");
      return;
    }
    const storageRef = storage.ref('valoraciones/' + Date.now() + "_" + file.name);
    try {
      const snapshot = await storageRef.put(file);
      photoURL = await snapshot.ref.getDownloadURL();
    } catch (err) {
      alert("Error al subir la foto: " + err.message);
      return;
    }
  }

  const reviewData = {
    name,
    comment,
    rating,
    photoURL,
    approved: false,
    timestamp: Date.now()
  };

  // Guardar en Realtime Database
  db.ref('valoraciones').push(reviewData)
    .then(() => {
      alert("Valoración enviada y pendiente de aprobación.");
      document.getElementById('reviewForm').reset();
    })
    .catch(err => {
      alert("Error al enviar valoración: " + err.message);
    });
});

// Mostrar valoraciones aprobadas
const reviewsDiv = document.getElementById('reviews');
db.ref('valoraciones').orderByChild('approved').equalTo(true).on('value', snapshot => {
  reviewsDiv.innerHTML = "";
  snapshot.forEach(child => {
    const data = child.val();
    const reviewEl = document.createElement('div');
    reviewEl.innerHTML = `
      <strong>${data.name}</strong> - ${'⭐'.repeat(data.rating)}<br>
      ${data.comment.length > 100 ? data.comment.substring(0,100) + '... <a href="#" onclick="alert(\''+data.comment+'\')">ver más</a>' : data.comment}<br>
      ${data.photoURL ? `<img src="${data.photoURL}" style="max-width:200px;"><br>` : ''}
      <hr>
    `;
    reviewsDiv.appendChild(reviewEl);
  });
});
</script>

</body>
</html>
