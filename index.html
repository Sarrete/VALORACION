<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Valoraciones</title>
<style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
    .container { max-width: 600px; margin: auto; background: #fff; padding: 20px; border-radius: 8px; }
    .stars { display: flex; gap: 5px; cursor: pointer; }
    .star { font-size: 2rem; color: lightgray; }
    .star.selected, .star.hover { color: gold; }
    .stars-display {
    color: gold;
    font-size: 1.5rem;
    margin: 0; }
    .review { border-bottom: 1px solid #ddd; padding: 10px 0; }
    img { max-width: 200px; display: block; margin-top: 5px; }
</style>
</head>
<body>
<div class="container">
    <h1>Deja tu valoración</h1>
    <form id="ratingForm">
        <label for="name">Tu nombre:</label>
        <input type="text" id="name" required><br><br>

        <label>Valoración:</label>
        <div class="stars" id="ratingStars">
            <span class="star" data-value="1">&#9733;</span>
            <span class="star" data-value="2">&#9733;</span>
            <span class="star" data-value="3">&#9733;</span>
            <span class="star" data-value="4">&#9733;</span>
            <span class="star" data-value="5">&#9733;</span>
        </div><br>

        <label for="comment">Comentario (opcional):</label>
        <textarea id="comment"></textarea><br><br>

        <label for="photo">Subir Foto (opcional):</label>
        <input type="file" id="photo"><br><br>

        <button type="submit">Enviar valoración</button>
    </form>

    <h2>Valoraciones Recientes</h2>
    <div id="reviews"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import { getFirestore, collection, addDoc, query, where, getDocs, serverTimestamp, orderBy } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-storage.js";

// Configuración Firebase
const firebaseConfig = {
  apiKey: "AIzaSyBqGTWa97hI7Olw1LqRKlXtKi6Y5yV0Yks",
  authDomain: "valoracion-web-11af4.firebaseapp.com",
  projectId: "valoracion-web-11af4",
  storageBucket: "valoracion-web-11af4.appspot.com",
  messagingSenderId: "281280264244",
  appId: "1:281280264244:web:6a07b7c0b61872ecf73261"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const storage = getStorage(app);

const form = document.getElementById('ratingForm');
const reviewsContainer = document.getElementById('reviews');
const stars = document.querySelectorAll('.star');
let selectedRating = 0;

// Función para manejar hover y selección de estrellas
stars.forEach(star => {
    star.addEventListener('mouseover', () => {
        const value = parseInt(star.dataset.value);
        stars.forEach(s => s.classList.toggle('hover', parseInt(s.dataset.value) <= value));
    });
    star.addEventListener('mouseout', () => {
        stars.forEach(s => s.classList.remove('hover'));
    });
    star.addEventListener('click', () => {
        selectedRating = parseInt(star.dataset.value);
        stars.forEach(s => s.classList.toggle('selected', parseInt(s.dataset.value) <= selectedRating));
    });
});

// Enviar valoración
form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const name = document.getElementById('name').value.trim();
    const comment = document.getElementById('comment').value;
    const photoFile = document.getElementById('photo').files[0];

    if (!name) { alert('Por favor, ingresa tu nombre.'); return; }
    if (selectedRating === 0) { alert('Por favor, selecciona una valoración.'); return; }

    try {
        let photoURL = null;
        if (photoFile) {
            const photoRef = ref(storage, `valoraciones/${Date.now()}_${photoFile.name}`);
            const snapshot = await uploadBytes(photoRef, photoFile);
            photoURL = await getDownloadURL(snapshot.ref);
        }

        await addDoc(collection(db, 'valoraciones'), {
            name,
            rating: selectedRating,
            comment: comment || 'Sin comentario',
            photoURL: photoURL || null,
            timestamp: serverTimestamp(),
            aprobado: false
        });

        alert('Valoración enviada correctamente. Se revisará antes de publicarla.');
        form.reset();
        selectedRating = 0;
        stars.forEach(s => s.classList.remove('selected'));
        loadReviews();

    } catch (err) {
        console.error(err);
        alert('Error al enviar la valoración.');
    }
});

// Cargar valoraciones aprobadas
async function loadReviews() {
  reviewsContainer.innerHTML = '';
  try {
    const q = query(collection(db, 'valoraciones'), where('aprobado', '==', true), orderBy('timestamp', 'desc'));
    const snapshot = await getDocs(q);
    snapshot.forEach(doc => {
      const data = doc.data();
      const div = document.createElement('div');
      div.classList.add('review');
      div.innerHTML = `
        <h3>${data.name}</h3>
        <p class="stars-display">
          ${'★'.repeat(data.rating)}${'☆'.repeat(5 - data.rating)}
        </p>
        <p>${data.comment}</p>
        ${data.photoURL ? `<img src="${data.photoURL}" alt="Foto valoracion">` : ''}
      `;
      reviewsContainer.appendChild(div);
    });
  } catch (err) {
    console.error(err);
  }
}


// Cargar reseñas al iniciar
loadReviews();
</script>
</body>
</html>
