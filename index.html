<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import { getFirestore, collection, addDoc, query, where, getDocs, serverTimestamp, orderBy } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-storage.js";

// Configuración de Firebase
const firebaseConfig = {
    apiKey: "AIzaSyBqGTWa97hI7Olw1LqRKlXtKi6Y5yV0Yks",
    authDomain: "valoracion-web-11af4.firebaseapp.com",
    projectId: "valoracion-web-11af4",
    storageBucket: "valoracion-web-11af4.appspot.com",
    messagingSenderId: "281280264244",
    appId: "1:281280264244:web:6a07b7c0b61872ecf73261"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const storage = getStorage(app);

// Referencias HTML
const form = document.getElementById('ratingForm');
const reviewsContainer = document.getElementById('reviews');
const stars = document.querySelectorAll('#ratingStars .star');
const ratingInput = document.getElementById('ratingValue');
let selectedRating = 0;

// Interacción de estrellas
stars.forEach(star => {
    const value = parseInt(star.dataset.value);

    star.addEventListener('mouseover', () => highlightStars(value));
    star.addEventListener('mouseout', () => highlightStars(selectedRating));
    star.addEventListener('click', () => {
        selectedRating = value;
        ratingInput.value = selectedRating;
        highlightStars(selectedRating);
    });
});

function highlightStars(rating) {
    stars.forEach(star => {
        const value = parseInt(star.dataset.value);
        star.classList.toggle('hover', value <= rating);
        star.classList.toggle('selected', value <= rating);
    });
}

// Enviar valoración
form.addEventListener('submit', async (e) => {
    e.preventDefault();

    const name = document.getElementById('name').value.trim();
    const rating = parseInt(ratingInput.value, 10);
    const comment = document.getElementById('comment').value;
    const photoFile = document.getElementById('photo').files[0];

    if (!name) { alert('Por favor, ingresa tu nombre.'); return; }
    if (!rating) { alert('Por favor, selecciona una valoración.'); return; }

    try {
        let photoURL = null;

        if (photoFile) {
            const photoRef = ref(storage, `valoraciones/${Date.now()}_${photoFile.name}`);
            const snapshot = await uploadBytes(photoRef, photoFile);
            photoURL = await getDownloadURL(snapshot.ref);
        }

        await addDoc(collection(db, 'valoraciones'), {
            name,
            rating,
            comment: comment || 'Sin comentario',
            photoURL: photoURL || null,
            timestamp: serverTimestamp(),
            aprobado: false
        });

        alert('Valoración enviada correctamente. Se revisará antes de publicarla.');
        form.reset();
        selectedRating = 0;
        highlightStars(0);
        loadReviews();

    } catch (error) {
        console.error('Error al enviar valoración:', error);
        alert('Ocurrió un error al enviar tu valoración.');
    }
});

// Cargar valoraciones aprobadas
async function loadReviews() {
    reviewsContainer.innerHTML = '';

    try {
        const q = query(collection(db, 'valoraciones'), where('aprobado', '==', true), orderBy('timestamp', 'desc'));
        const snapshot = await getDocs(q);

        snapshot.forEach(doc => {
            const data = doc.data();
            const div = document.createElement('div');
            div.classList.add('review');

            // Crear estrellas doradas
            const starsDiv = document.createElement('div');
            for (let i = 1; i <= 5; i++) {
                const star = document.createElement('span');
                star.innerHTML = '&#9733;';
                star.style.color = i <= data.rating ? '#FFD700' : '#ccc';
                star.style.fontSize = '20px';
                star.style.marginRight = '2px';
                starsDiv.appendChild(star);
            }

            div.innerHTML = `
                <h3>${data.name}</h3>
                <p>${data.comment}</p>
                ${data.photoURL ? `<img src="${data.photoURL}" alt="Foto valoracion" style="max-width:200px;">` : ''}
                <hr>
            `;
            div.insertBefore(starsDiv, div.querySelector('p'));

            reviewsContainer.appendChild(div);
        });

    } catch (error) {
        console.error('Error al cargar valoraciones:', error);
    }
}

// Inicializar valoraciones
loadReviews();
</script>
tml>
